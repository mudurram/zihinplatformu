// =============================================================
// ðŸ“Œ remember.js â€” Oturum HatÄ±rlatma & LocalStorage YÃ¶netimi
// Zihin Platformu v6.4 â€” Final, Stabil, KÄ±rÄ±lmaz YapÄ±
// =============================================================

import { watchAuthState } from "./auth.js";
import { ROLES } from "../platform/router.js";

console.log("remember.js yÃ¼klendi âœ”");

// =============================================================
// ðŸ” 1) Firebase Oturumunu Ä°zle
// =============================================================
// KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸsa localStorage oto-dolum yapÄ±lÄ±r.
// Ã‡Ä±kÄ±ÅŸ yapmÄ±ÅŸsa localStorage temizlenir.
//
watchAuthState(user => {
  if (!user) {
    console.warn("ðŸ”¸ remember.js â†’ Oturum yok â†’ storage temizleniyor.");
    localStorage.removeItem("uid");
    localStorage.removeItem("loggedUser");
    return;
  }

  console.log("ðŸ”¹ remember.js â†’ Oturum bulundu:", user.email);

  // EÄŸer bilgiler kayÄ±tlÄ± deÄŸilse â†’ doldur
  if (!localStorage.getItem("uid")) {
    localStorage.setItem("uid", user.uid);
  }

  if (!localStorage.getItem("loggedUser")) {
    localStorage.setItem("loggedUser", user.email);
  }
});

// =============================================================
// ðŸ“Œ 2) Rol GÃ¼venliÄŸi â€” Rol kaydÄ± eksikse Ã¶ÄŸrenci atanÄ±r
// =============================================================
export function ensureRole() {
  let role = localStorage.getItem("role");

  if (!role) {
    console.warn("âš  remember.js â†’ Rol bulunamadÄ± â†’ OGRENCI atanÄ±yor.");
    role = ROLES.OGRENCI;
    localStorage.setItem("role", role);
  }

  return role;
}

// =============================================================
// ðŸ“Œ 3) Ã–ÄŸretmen BaÄŸlantÄ±sÄ± HatÄ±rlatma
// =============================================================
export function ensureTeacherLink() {
  const role = localStorage.getItem("role");

  if (role === ROLES.OGRETMEN) {
    const uid = localStorage.getItem("uid");

    if (uid && !localStorage.getItem("teacherID")) {
      console.log("ðŸ“˜ remember.js â†’ teacherID kaydedildi:", uid);
      localStorage.setItem("teacherID", uid);
    }
  }
}

// =============================================================
// ðŸ“Œ 4) TÃ¼m HatÄ±rlatma Ä°ÅŸlemini BaÅŸlat
// =============================================================
export function initRemember() {
  console.log("ðŸš€ remember.js â†’ Oturum & Rol & BaÄŸlantÄ± kontrolÃ¼ baÅŸlatÄ±ldÄ±.");

  ensureRole();
  ensureTeacherLink();
}

initRemember();
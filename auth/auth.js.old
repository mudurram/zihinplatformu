// =============================================================
// ğŸ“Œ auth.js â€” Firebase Authentication + Rol YÃ¶nlendirme (Final v6.4 - Username Destekli)
// =============================================================
//
// Bu dosya login, register, logout ve rol + UID yÃ¶netimini yapar.
// router.js ve globalConfig.js ile %100 uyumludur.
// =============================================================

import { auth, db } from "../data/firebaseConfig.js";
import { ROLES, yonlendir } from "../platform/router.js";

import {
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  doc,
  getDoc,
  setDoc,
  query,
  collection,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

console.log("auth.js yÃ¼klendi âœ…");


// =============================================================
// ğŸŸ© 1) LOGIN â€” Username â†’ Email Destekli (Final)
// =============================================================
export async function login(usernameOrEmail, password) {
  try {
    console.log("â¡ GiriÅŸ yapÄ±lÄ±yor...");

    let email = usernameOrEmail.trim();

    // ---------------------------------------------------------
    // ğŸ”¥ Username ile giriÅŸ (Ã¶r: "ogretmen", "yusuf")
    // ---------------------------------------------------------
    if (!email.includes("@")) {
      console.log("â¡ KullanÄ±cÄ± adÄ± ile giriÅŸ algÄ±landÄ±:", email);

      const q = query(
        collection(db, "profiles"),
        where("username", "==", email)
      );

      const qSnap = await getDocs(q);

      if (qSnap.empty) {
        return { success: false, message: "KullanÄ±cÄ± bulunamadÄ±!" };
      }

      const userDoc = qSnap.docs[0];
      email = userDoc.data().email;

      console.log("â¡ KullanÄ±cÄ± adÄ± â†’ Email bulundu:", email);
    }

    // ---------------------------------------------------------
    // ğŸ”µ Firebase Auth GiriÅŸi (Email + Åifre)
    // ---------------------------------------------------------
    const result = await signInWithEmailAndPassword(auth, email, password);
    const uid = result.user.uid;

    // ---------------------------------------------------------
    // ğŸŸ¦ Profil Bilgisi YÃ¼kle
    // ---------------------------------------------------------
    const ref = doc(db, "profiles", uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      alert("âš  KullanÄ±cÄ± profil bilgisi bulunamadÄ±!");
      console.warn("Profil Firestore iÃ§inde yok.");
      return { success: false };
    }

    const data = snap.data();
    const role = data.role || ROLES.OGRENCI;

    // ---------------------------------------------------------
    // ğŸ” LocalStorage â€” Ortak Merkez Veri
    // ---------------------------------------------------------
    localStorage.setItem("uid", uid);
    localStorage.setItem("loggedUser", email);
    localStorage.setItem("role", role);
    localStorage.setItem("username", data.username || "");

    // Ã–ÄŸretmen ise kendi UIDâ€™si teacherID olur
    if (role === ROLES.OGRETMEN) {
      localStorage.setItem("teacherID", uid);
    }

    console.log("ğŸ‰ GiriÅŸ baÅŸarÄ±lÄ± â†’ Rol:", role);

    // ---------------------------------------------------------
    // ğŸ”€ Rol YÃ¶nlendirme
    // ---------------------------------------------------------
    yonlendir(role);

    return { success: true };

  } catch (err) {
    console.error("ğŸš« Login hatasÄ±:", err);

    let mesaj = "GiriÅŸ yapÄ±lamadÄ±.";

    switch (err.code) {
      case "auth/invalid-email": mesaj = "GeÃ§ersiz e-posta!"; break;
      case "auth/user-not-found": mesaj = "KullanÄ±cÄ± bulunamadÄ±!"; break;
      case "auth/wrong-password": mesaj = "Åifre yanlÄ±ÅŸ!"; break;
      case "auth/too-many-requests": mesaj = "Ã‡ok fazla deneme, bekleyin!"; break;
    }

    return { success: false, message: mesaj };
  }
}


// =============================================================
// ğŸŸ¦ 2) REGISTER (Final GÃ¼venlikli)
// =============================================================
export async function register(email, password, role = ROLES.OGRENCI) {
  try {
    console.log("ğŸ“ KayÄ±t oluÅŸturuluyor...");

    const result = await createUserWithEmailAndPassword(auth, email, password);
    const uid = result.user.uid;

    await setDoc(doc(db, "profiles", uid), {
      email,
      role,
      username: email.split("@")[0],
      createdAt: new Date().toISOString()
    });

    console.log("ğŸ‰ KayÄ±t baÅŸarÄ±lÄ± â†’ UID:", uid);

    return { success: true };

  } catch (err) {
    console.error("ğŸš« KayÄ±t hatasÄ±:", err.message);

    let mesaj = "KayÄ±t yapÄ±lamadÄ±.";

    switch (err.code) {
      case "auth/email-already-in-use": mesaj = "Bu e-posta zaten kayÄ±tlÄ±!"; break;
      case "auth/invalid-email": mesaj = "GeÃ§ersiz e-posta!"; break;
      case "auth/weak-password": mesaj = "Åifre Ã§ok zayÄ±f!"; break;
    }

    return { success: false, message: mesaj };
  }
}


// =============================================================
// ğŸŸ¥ 3) LOGOUT
// =============================================================
export async function logout() {
  try {
    await signOut(auth);
    localStorage.clear();
    return true;
  } catch (err) {
    console.error("Ã‡Ä±kÄ±ÅŸ hatasÄ±:", err);
    return false;
  }
}


// =============================================================
// ğŸŸ¨ 4) OTURUM DÄ°NLEYÄ°CÄ°
// =============================================================
export function watchAuthState(callback) {
  return auth.onAuthStateChanged(callback);
}
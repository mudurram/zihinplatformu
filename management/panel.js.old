// ============================================================================
// ğŸ“˜ panel.js â€” Ã–ÄŸretmen Paneli (Final v6.4)
// Ã–ÄŸrenci Listeleme + Analiz YÃ¶nlendirme + Rol GÃ¼venliÄŸi
// ============================================================================

console.log("ğŸ“˜ panel.js yÃ¼klendi (v6.4 Final)");

// ============================================================================
// ğŸ”— Firebase BaÄŸlantÄ±larÄ±
// ============================================================================
import { auth, db } from "../data/firebaseConfig.js";

import {
  collection,
  doc,
  getDoc,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// HTML referansÄ±
const ogrenciListesi = document.getElementById("ogrenciListesi");

// ============================================================================
// ğŸ›¡ 1) KullanÄ±cÄ± Takibi + Rol KontrolÃ¼
// ============================================================================
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.warn("â›” Oturum yok â†’ login.html");
    window.location.href = "../auth/login.html";
    return;
  }

  const uid = user.uid;
  console.log("ğŸ‘©â€ğŸ« Ã–ÄŸretmen giriÅŸ yaptÄ±:", uid);

  // Firestoreâ€™dan profilini okuyoruz
  const ref = doc(db, "profiles", uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("Ã–ÄŸretmen profili bulunamadÄ±!");
    return;
  }

  const data = snap.data();

  if (data.role !== "ogretmen") {
    console.warn("â›” Bu sayfaya yalnÄ±zca Ã¶ÄŸretmen girebilir!");
    window.location.href = "../platform/index.html";
    return;
  }

  // Ã–ÄŸrenciler alt koleksiyonunu yÃ¼kle
  loadTeacherStudents(uid);
});

// ============================================================================
// ğŸ“¥ 2) Ã–ÄŸretmenin Ã¶ÄŸrencilerini Firestoreâ€™dan yÃ¼kle
// ============================================================================
async function loadTeacherStudents(teacherUid) {
  try {
    const ogrRef = collection(db, "profiles", teacherUid, "ogrenciler");
    const snap = await getDocs(ogrRef);

    ogrenciListesi.innerHTML = ""; // Ã¶nce temizle

    if (snap.empty) {
      ogrenciListesi.innerHTML =
        "<p style='text-align:center; opacity:.7;'>KayÄ±tlÄ± Ã¶ÄŸrenci bulunmuyor.</p>";
      return;
    }

    snap.forEach((docu) => {
      const ogrID = docu.id;
      const data = docu.data();

      const isim = data.ad || data.username || "Ä°simsiz Ã–ÄŸrenci";

      const div = document.createElement("div");
      div.className = "ogrenci-item";
      div.innerHTML = `
        <span>${isim}</span>
        <button data-id="${ogrID}">Analiz</button>
      `;

      div.querySelector("button").addEventListener("click", () => {
        localStorage.setItem("aktifOgrenciId", ogrID);
        localStorage.setItem("aktifOgrenci", isim);

        console.log("ğŸ” Analize gidiliyor â†’", ogrID);
        window.location.href = "../platform/analiz.html";
      });

      ogrenciListesi.appendChild(div);
    });
  } catch (err) {
    console.error("âš ï¸ Ã–ÄŸrenci listesi yÃ¼klenirken hata:", err);
    ogrenciListesi.innerHTML =
      "<p style='text-align:center; opacity:.7;'>Hata oluÅŸtu.</p>";
  }
}

// ============================================================================
// ğŸšª 3) Ã‡Ä±kÄ±ÅŸ
// ============================================================================
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  localStorage.clear();
  window.location.href = "../auth/login.html";
});

console.log("ğŸ“˜ panel.js Ã§alÄ±ÅŸtÄ± (Ã–ÄŸretmen kontrol sistemi aktif)");
// =============================================================
// ðŸ“˜ teacherAI.js â€” Ã–ÄŸretmen AI Analiz Motoru (Final v6.6)
// =============================================================
// Bu dosya, Zihin Platformu analiz altyapÄ±sÄ±nÄ±n Ã¶ÄŸretmen odaklÄ±
// geliÅŸmiÅŸ yapay zeka yorumlarÄ±nÄ± Ã¼retir.
// =============================================================

console.log("teacherAI.js (v6.6) yÃ¼klendi âœ”");


// =============================================================
// 0) KALITIM â€” Eski Ã¶ÄŸretmen yorumu korundu
// =============================================================
export function teacherAI_generateAdvice(result) {
  if (!result || !result.skorlar) return "Veri bulunamadÄ±.";

  const r = result.skorlar.reaction_speed ?? 0;
  const a = result.skorlar.sustained_attention ?? 0;
  const i = result.skorlar.inhibitory_control ?? 0;

  let advice = "ðŸ§  Ã–ÄŸretmen DeÄŸerlendirmesi\n\n";

  // Tepki HÄ±zÄ±
  if (r < 40) advice += "âš¡ **Tepki HÄ±zÄ±:** Ã‡ok dÃ¼ÅŸÃ¼k â€” hÄ±zlÄ± tepki oyunlarÄ± Ã¶nerilir.\n\n";
  else if (r < 70) advice += "âš¡ **Tepki HÄ±zÄ±:** Ortalama â€” hÄ±z artÄ±rma egzersizleri eklenebilir.\n\n";
  else advice += "âš¡ **Tepki HÄ±zÄ±:** GÃ¼Ã§lÃ¼ bir refleks kontrolÃ¼ mevcut.\n\n";

  // Dikkat
  if (a < 40) advice += "ðŸŽ¯ **Dikkat SÃ¼rekliliÄŸi:** DalgÄ±nlÄ±k var â€” sÃ¼reli gÃ¶revler etkili olur.\n\n";
  else if (a < 70) advice += "ðŸŽ¯ **Dikkat SÃ¼rekliliÄŸi:** Orta seviye â€” stabilite artÄ±rÄ±labilir.\n\n";
  else advice += "ðŸŽ¯ **Dikkat SÃ¼rekliliÄŸi:** Ã‡ok iyi.\n\n";

  // Ä°nhibisyon
  if (i < 40) advice += "ðŸ›‘ **Ä°nhibisyon:** Aceleci davranÄ±ÅŸ gÃ¶zleniyor â€” engelleme oyunlarÄ± Ã¶nerilir.\n\n";
  else if (i < 70) advice += "ðŸ›‘ **Ä°nhibisyon:** KontrollÃ¼ fakat geliÅŸtirilebilir.\n\n";
  else advice += "ðŸ›‘ **Ä°nhibisyon:** Ä°leri dÃ¼zey kontrol sergiliyor.\n\n";

  advice += "ðŸ“Œ DÃ¼zenli tekrar tÃ¼m becerilerin dengeli geliÅŸmesine katkÄ± saÄŸlar.";

  return advice;
}



// =============================================================
// 1) Son N oyunu Ã§ek
// =============================================================
export function getLastGames(history, limit = 10) {
  if (!Array.isArray(history)) return [];
  return history.slice(-limit);
}



// =============================================================
// 2) Ortalama hesaplama (genel amaÃ§lÄ±)
// =============================================================
function ortalama(arr) {
  if (!Array.isArray(arr) || arr.length === 0) return 0;
  return Math.round(arr.reduce((a, b) => a + b, 0) / arr.length);
}



// =============================================================
// 3) BileÅŸen ortalamalarÄ±
// =============================================================
export function calculateComponentAverages(history) {
  if (!history || history.length === 0) return null;

  const comp = {
    reaction_speed: [],
    inhibitory_control: [],
    sustained_attention: []
  };

  history.forEach(h => {
    if (h?.skorlar) {
      comp.reaction_speed.push(h.skorlar.reaction_speed ?? 0);
      comp.inhibitory_control.push(h.skorlar.inhibitory_control ?? 0);
      comp.sustained_attention.push(h.skorlar.sustained_attention ?? 0);
    }
  });

  return {
    reaction_avg: ortalama(comp.reaction_speed),
    inhibition_avg: ortalama(comp.inhibitory_control),
    attention_avg: ortalama(comp.sustained_attention)
  };
}



// =============================================================
// 4) GÃ¼Ã§lÃ¼ â€“ ZayÄ±f Beceri Analizi
// =============================================================
export function analyzeStrengthsWeakness(history) {
  const avg = calculateComponentAverages(history);
  if (!avg) return null;

  const entries = [
    { key: "Tepki HÄ±zÄ±", value: avg.reaction_avg },
    { key: "Ä°nhibisyon", value: avg.inhibition_avg },
    { key: "Dikkat SÃ¼rekliliÄŸi", value: avg.attention_avg }
  ];

  const sorted = entries.sort((a, b) => a.value - b.value);

  return {
    weakest: sorted[0],
    strongest: sorted[2],
    middle: sorted[1]
  };
}



// =============================================================
// 5) Trend HesabÄ± (son oyun - bir Ã¶nceki)
// =============================================================
export function getImprovementTrend(history) {
  if (!history || history.length < 2) return "Veri yetersiz";

  const son = history.at(-1)?.skorlar;
  const onceki = history.at(-2)?.skorlar;

  if (!son || !onceki) return "Veri yetersiz";

  return {
    reaction: son.reaction_speed - onceki.reaction_speed,
    attention: son.sustained_attention - onceki.sustained_attention,
    inhibition: son.inhibitory_control - onceki.inhibitory_control
  };
}



// =============================================================
// 6) Kritik DÃ¼ÅŸÃ¼ÅŸ AlgÄ±lama
// =============================================================
export function detectDrop(history) {
  if (!history || history.length < 3) return null;

  const last = history.at(-1)?.skorlar;
  const prev = history.at(-2)?.skorlar;

  if (!last || !prev) return null;

  const drop = {
    reaction: prev.reaction_speed - last.reaction_speed,
    attention: prev.sustained_attention - last.sustained_attention,
    inhibition: prev.inhibitory_control - last.inhibitory_control
  };

  let critical = [];

  Object.keys(drop).forEach(k => {
    if (drop[k] >= 15) {
      critical.push({
        component: k,
        amount: drop[k]
      });
    }
  });

  return critical.length ? critical : null;
}



// =============================================================
// 7) AI Ã¶neri motoru â€” Ã–ÄŸretmen Ã¶nerileri
// =============================================================
export function generateRecommendations(history) {
  const avg = calculateComponentAverages(history);
  if (!avg) return [];

  const rec = [];

  if (avg.reaction_avg < 50)
    rec.push("â± Tepki hÄ±zÄ±nÄ± artÄ±rmak iÃ§in hÄ±zlÄ± eÅŸleme oyunlarÄ± Ã¶nerilir.");

  if (avg.attention_avg < 50)
    rec.push("ðŸŽ¯ Dikkat sÃ¼rekliliÄŸi zayÄ±f â€” uzun sÃ¼reli odak oyunlarÄ± tercih edilebilir.");

  if (avg.inhibition_avg < 50)
    rec.push("ðŸ›‘ Ä°nhibisyon dÃ¼ÅŸÃ¼k â€” hata baskÄ±lama gerektiren oyunlarla desteklenebilir.");

  if (rec.length === 0)
    rec.push("ðŸ“ˆ TÃ¼m bileÅŸenlerde gÃ¼Ã§lÃ¼, zorluk seviyesi artÄ±rÄ±labilir.");

  return rec;
}



// =============================================================
// 8) Ana Fonksiyon â€” Ã–ÄŸretmene tam rapor
// =============================================================
export function fullTeacherAnalysis(history) {
  const last = getLastGames(history, 10);

  return {
    average: calculateComponentAverages(last),
    strengthsWeakness: analyzeStrengthsWeakness(last),
    trend: getImprovementTrend(last),
    criticalDrops: detectDrop(last),
    recommendations: generateRecommendations(last)
  };
}
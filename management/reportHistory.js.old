// ==========================================================================
// ğŸ“˜ reportHistory.js â€” Ã–ÄŸrenci TÃ¼m GeÃ§miÅŸ Rapor Listesi (Final v6.4)
// ==========================================================================

console.log("ğŸ“˜ reportHistory.js yÃ¼klendi");

// --------------------------------------------------------------------------
// ğŸ”— Firebase
// --------------------------------------------------------------------------
import { db } from "../data/firebaseConfig.js";
import {
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// --------------------------------------------------------------------------
// ğŸ”— GLOBAL OYUN ADLARI (isimleri dÃ¼zgÃ¼n gÃ¶stermek iÃ§in)
// --------------------------------------------------------------------------
import { GLOBAL } from "../platform/globalConfig.js";

// --------------------------------------------------------------------------
// ğŸ” 1) Aktif Ã–ÄŸrenciyi Yerelden YÃ¼kle
// --------------------------------------------------------------------------
const aktifAd = localStorage.getItem("aktifOgrenci") || "-";
const aktifId = localStorage.getItem("aktifOgrenciId");

document.getElementById("historyTitle").textContent =
  `${aktifAd} â€” GeÃ§miÅŸ Oyun KayÄ±tlarÄ±`;

if (!aktifId) {
  alert("âš ï¸ Ã–ÄŸrenci seÃ§ili deÄŸil!");
  throw new Error("aktifOgrenciId bulunamadÄ±");
}

// --------------------------------------------------------------------------
// ğŸŸ¦ 2) Firestoreâ€™dan geÃ§miÅŸ sonuÃ§larÄ± Ã§ek
// --------------------------------------------------------------------------
async function loadHistory() {
  try {
    const ref = collection(db, "profiles", aktifId, "results");
    const snap = await getDocs(ref);

    let kayitlar = [];

    snap.forEach(docu => {
      const d = docu.data();

      kayitlar.push({
        oyun: d.oyun || "-",
        dogru: d.dogru ?? 0,
        yanlis: d.yanlis ?? 0,
        seviye: d.level ?? "-",
        sure: d.sure ?? "-",
        skorlar: d.skorlar || {},
        tarih: d.tarih ? new Date(d.tarih) : new Date()
      });
    });

    // Tarihe gÃ¶re yeni â†’ eski sÄ±rala
    kayitlar.sort((a, b) => b.tarih - a.tarih);

    tabloyuDoldur(kayitlar);

  } catch (err) {
    console.error("âŒ GeÃ§miÅŸ verileri yÃ¼klenemedi:", err);
  }
}

// --------------------------------------------------------------------------
// ğŸŸ© 3) Tabloyu HTML'e yaz
// --------------------------------------------------------------------------
function tabloyuDoldur(list) {
  const tbody = document.getElementById("historyBody");
  tbody.innerHTML = "";

  if (list.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align:center; opacity:0.6;">
          KayÄ±t bulunamadÄ±.
        </td>
      </tr>`;
    return;
  }

  list.forEach(k => {
    const oyunAdi =
      GLOBAL.OYUN_ADLARI?.[k.oyun] ||
      k.oyun.replace("_", " ").toUpperCase();

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${oyunAdi}</td>
      <td>${k.seviye}</td>
      <td>${k.dogru}</td>
      <td>${k.yanlis}</td>
      <td>${k.sure}</td>
      <td>${k.tarih.toLocaleString("tr-TR")}</td>
      <td>
        <button class="inceleBtn" data-oyun="${k.oyun}">
          Ä°ncele
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });

  incelemeButonlariniHazirla();
}

// --------------------------------------------------------------------------
// ğŸŸ§ 4) Ä°ncele â†’ platform/sonuc.html yÃ¶nlendirme
// --------------------------------------------------------------------------
function incelemeButonlariniHazirla() {
  document.querySelectorAll(".inceleBtn").forEach(btn => {

    btn.addEventListener("click", () => {
      const oyun = btn.dataset.oyun;

      // Son incelenen oyun kodu
      localStorage.setItem("sonOyun", oyun);

      // SeÃ§ilen oyun geÃ§miÅŸteki kayÄ±tlardan biri â†’ sonuÃ§ ekranÄ± aÃ§Ä±lÄ±r
      window.location.href = "../platform/sonuc.html";
    });

  });
}

// --------------------------------------------------------------------------
// âœ” SayfayÄ± baÅŸlat
// --------------------------------------------------------------------------
loadHistory();
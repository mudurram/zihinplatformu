// =============================================================
// ðŸ“Œ gameEngine.js â€” Oyun Motoru (Final v6.4 - KararlÄ± SÃ¼rÃ¼m)
// =============================================================
//
// Bu motor her oyunda kullanÄ±lÄ±r:
//  - Zaman yÃ¶netimi
//  - Trial kaydÄ±
//  - Tepki sÃ¼resi hesaplama
//  - BileÅŸen Ã§Ä±karma (componentCalculator)
//  - Normalizasyon (normalizer)
//  - Trial etiketleme (trialLabeler)
//  - SonuÃ§larÄ±n localStorage'a yazÄ±lmasÄ±
//  - SonuÃ§ ekranÄ±na yÃ¶nlendirme
//
// =============================================================

import { labelTrials } from "./trialLabeler.js";
import { calculateComponents } from "./componentCalculator.js";
import { normalizeComponents } from "./normalizer.js";
import { saveGameResult } from "../data/gameResultService.js";  // Firestore opsiyonel

console.log("gameEngine.js yÃ¼klendi âœ”");

// =============================================================
// ðŸŽ® GAME ENGINE SINIFI
// =============================================================
export class GameEngine {
  constructor({ gameName, timeLimit = 30 }) {
    this.gameName = gameName;
    this.timeLimit = timeLimit;

    this.score = 0;
    this.mistakes = 0;
    this.trials = [];

    this.timeLeft = timeLimit;
    this.timerInterval = null;

    this.updateUI = null;
  }

  // =========================================================
  // â–¶ï¸ Oyunu BaÅŸlat
  // =========================================================
  start(updateUI) {
    this.updateUI = updateUI;
    this.startTimer();
  }

  // =========================================================
  // ðŸ“ Her tepkiyi kaydet
  // =========================================================
  recordTrial({ correct, reaction_ms }) {
    this.trials.push({ correct, reaction_ms });

    if (correct) this.score++;
    else this.mistakes++;

    if (this.updateUI)
      this.updateUI(this.score, this.mistakes, this.timeLeft);
  }

  // =========================================================
  // â± ZamanlayÄ±cÄ± baÅŸlatÄ±r
  // =========================================================
  startTimer() {
    this.timerInterval = setInterval(() => {
      this.timeLeft--;

      if (this.updateUI)
        this.updateUI(this.score, this.mistakes, this.timeLeft);

      if (this.timeLeft <= 0) this.endGame();
    }, 1000);
  }

  // =========================================================
  // ðŸ”š OYUN BÄ°TÄ°ÅžÄ° (ANALÄ°Z + KAYIT + YÃ–NLENDÄ°RME)
  // =========================================================
  async endGame() {
    clearInterval(this.timerInterval);

    // Trial etiketi (reaction / inhibition / focus)
    const labeled = labelTrials(this.trials);

    // Ham bileÅŸen hesaplarÄ±
    const raw = calculateComponents(labeled);

    // Normalize edilmiÅŸ 0â€“100 arasÄ± puanlar
    const normalized = normalizeComponents(raw);

    // TAM OYUN SONUCU OBJESÄ°
    const result = {
      oyun: this.gameName,
      dogru: this.score,
      yanlis: this.mistakes,
      skorlar: normalized,
      tarih: new Date().toISOString(),
      trials: labeled
    };

    // ========================================
    // ðŸ“Œ LocalStorage KAYDI
    // ========================================
    let history = JSON.parse(localStorage.getItem("oyunGecmisi")) || [];
    history.push(result);

    localStorage.setItem("oyunGecmisi", JSON.stringify(history));
    localStorage.setItem("sonOyun", this.gameName);
    localStorage.setItem("sonOyunSonuc", JSON.stringify(result));

    // ========================================
    // ðŸ“Œ Firestore'a KAYIT (opsiyonel)
    // ========================================
    await saveGameResult({
      game: this.gameName,
      score: this.score,
      mistakes: this.mistakes,
      components: normalized
    });

    // ========================================
    // ðŸ“Œ PLATFORM SONUÃ‡ SAYFASINA YÃ–NLENDÄ°R
    // ========================================
    window.location.href = "../../platform/sonuc.html";
  }
}
// =============================================================
// ğŸ“Œ componentCalculator.js â€” BiliÅŸsel BileÅŸen HesaplayÄ±cÄ± (Final v6.4)
// =============================================================
//
// Gelen trial verilerini analiz eder ve ÅŸu 3 bileÅŸenin HAM skorunu Ã¼retir:
//   â€¢ reaction_speed
//   â€¢ inhibitory_control
//   â€¢ sustained_attention
//
// Bu deÄŸerler SONRA normalizer.js ile 0â€“100'e normalize edilir.
// =============================================================


// -------------------------------------------------------------
// ğŸ§® GÃ¼venli ortalama
// -------------------------------------------------------------
function avg(arr) {
  if (!Array.isArray(arr) || arr.length === 0) return 0;
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}


// -------------------------------------------------------------
// ğŸ¯ Hesaplama Motoru
// -------------------------------------------------------------
export function calculateComponents(trials) {
  if (!Array.isArray(trials) || trials.length === 0) {
    return {
      reaction_speed: 0,
      inhibitory_control: 0,
      sustained_attention: 0
    };
  }

  // -----------------------------------------------------------
  // 1) Reaction Speed (ms cinsinden ortalama)
  // -----------------------------------------------------------
  const reactionArr = trials
    .filter(t => t.correct === true && typeof t.reaction_ms === "number")
    .map(t => t.reaction_ms);

  const reaction_speed = avg(reactionArr) || 0;


  // -----------------------------------------------------------
  // 2) Inhibitory Control (hata oranÄ±)
  // -----------------------------------------------------------
  const totalTrials = trials.length;
  const errors = trials.filter(t => t.correct === false).length;

  // Hata oranÄ± â†’ daha az hata = daha iyi kontrol
  // Bu ham deÄŸer normalize edilecek
  const inhibitory_control = totalTrials > 0
    ? 100 - (errors / totalTrials) * 100   // 100 = hiÃ§ hata yok
    : 0;


  // -----------------------------------------------------------
  // 3) Sustained Attention (ikinci yarÄ±daki bozulma)
  // -----------------------------------------------------------
  const mid = Math.floor(trials.length / 2);

  const firstHalf = trials.slice(0, mid);
  const secondHalf = trials.slice(mid);

  const fErr = firstHalf.filter(t => t.correct === false).length;
  const sErr = secondHalf.filter(t => t.correct === false).length;

  // Dikkat kaymasÄ± = ikinci yarÄ±daki hata artÄ±ÅŸÄ±
  const dikkatKayÄ±p = sErr - fErr;

  // Pozitif ise dikkat dÃ¼ÅŸmÃ¼ÅŸ demektir â†’ daha dÃ¼ÅŸÃ¼k skor
  let sustained_attention = 100 - (dikkatKayÄ±p * 15); 
  sustained_attention = Math.max(0, Math.min(100, sustained_attention));


  // -----------------------------------------------------------
  // EÄŸer sadece tek trial oynandÄ±ysa fallback
  // -----------------------------------------------------------
  if (trials.length < 2) {
    return {
      reaction_speed: reaction_speed || 0,
      inhibitory_control: inhibitory_control || 0,
      sustained_attention: 80 // en az 2 trial yoksa nÃ¶tr deÄŸer
    };
  }

  // -----------------------------------------------------------
  // TAM Ã‡IKTI
  // -----------------------------------------------------------
  return {
    reaction_speed,
    inhibitory_control,
    sustained_attention
  };
}

console.log("ğŸ“˜ componentCalculator.js yÃ¼klendi (Final v6.4)");